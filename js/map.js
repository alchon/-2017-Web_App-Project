var map = document.createElement("div");
map.setAttribute("class", "map")
map.innerHTML = `<svg version="1.1" id="layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
     y="0px" width="814.382px" height="927px" viewBox="0 0 814.382 927" enable-background="new 0 0 814.382 927"
     xml:space="preserve">
                <rect x="436.629" y="158.833" fill="#A9CA9A" stroke="#000000" stroke-miterlimit="10" width="151.954" height="62.333"/>
                <rect x="436.629" y="232.065" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.954" height="72.861"/>
                <rect x="601.337" y="158.833" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="212.545" height="146.093"/>
                <rect x="436.629" y="315.825" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.954" height="69.849"/>
                <rect x="601.337" y="315.825" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="212.545" height="69.849"/>
                <rect x="436.629" y="397.744" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.954" height="81.115"/>
                <rect x="601.337" y="397.744" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="212.545" height="81.115"/>
                
                <rect x="601.337" y="490.561" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="212.545" height="39.261"/>
                <rect x="601.337" y="113.266" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="212.545" height="34.668"/>
                <rect x="436.629" y="113.266" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.954" height="34.668"/>
                <rect x="211.713" y="0.5" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="184.094" height="37.768"/>
                <rect x="0.5" y="0.5" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="199.653" height="37.768"/>
                <rect x="0.5" y="49.167" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="33.975" height="96.333"/>
                <rect x="47.229" y="49.166" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="72.508" height="96.333"/>
                <rect x="131.297" y="49.167" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="68.856" height="96.333"/>
                <rect x="211.713" y="49.167" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="65.22" height="96.333"/>
                <rect x="436.629" y="490.561" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.954" height="39.261"></rect>
                <rect x="436.629" y="570.5" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="275.331" height="70.184"/>
                <rect x="724.714" y="652.385" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="89.168" height="66.747"/>
                <rect x="436.629" y="652.385" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="275.331" height="66.747"/>
                <rect x="724.714" y="570.5" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="89.168" height="70.184"></rect>
                <rect x="436.629" y="730.833" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="275.331" height="65.3"></rect>                <rect x="724.714" y="730.833" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="89.168" height="195.667"/>
                <rect x="436.629" y="807.834" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="214.332" height="60.999"></rect>
                <rect x="436.629" y="880.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="275.331" height="45.966"/>
                <rect x="276.641" y="866.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="119.167" height="59.966"/>
                <rect x="113.39" y="866.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="151.69" height="59.966"/>
                <rect x="0.5" y="866.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="101.33" height="59.966"/>
                <rect x="69.932" y="643.534" fill="#A9CA9A" stroke="#000000" stroke-miterlimit="10" width="76.69" height="44.299"/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="58.372,687.833 58.372,631.833 158.182,631.833
                    158.182,687.833 226.807,687.833 226.807,570.5 0.5,570.5 0.5,687.833 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="312.747,652.385 288.081,652.385 288.081,570.5
                    238.367,570.5 238.367,687.833 312.747,687.833 "/>
                <rect x="299.641" y="570.5" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="96.167" height="70.184"/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="288.494,145.794 288.494,49.166 395.807,49.166
                    395.807,221.167 364.317,221.167 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="329.275,203.191 358.148,232.065 395.807,232.065
                    395.807,304.926 340.268,304.926 283.904,248.563 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="275.596,256.871 223.569,308.897 300.346,385.674
                    395.807,385.674 395.807,315.825 334.549,315.825 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="395.807,478.859 395.807,397.744 295.799,397.744
                    215.261,317.206 164.11,368.357 274.613,478.859 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="197.896,418.761 269.696,490.561 395.807,490.561
                    395.807,529.821 159.781,529.821 159.781,456.877 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="189.588,410.452 155.802,376.666 68.312,464.156
                    91.682,487.525 91.682,529.821 148.221,529.821 148.221,451.82 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="275.596,240.255 211.713,176.373 211.713,158.833
                    284.917,158.833 320.967,194.884 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="267.288,248.563 215.261,300.589 131.297,216.626
                    131.297,158.833 200.153,158.833 200.153,181.429 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="155.802,360.049 206.953,308.897 119.737,221.682
                    119.737,158.833 47.229,158.833 47.229,251.477 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="72.025,364.333 107.747,328.611 34.475,255.339
                    34.475,158.833 0.5,158.833 0.5,364.333 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="0.5,438.602 42.756,438.602 60.003,455.848
                    147.493,368.357 116.055,336.919 77.743,375.231 0.5,375.231 "/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="80.122,529.821 80.122,492.583 37.038,449.5 0.5,449.5
                    0.5,529.821 "/>
                <rect x="650.961" y="807.834" fill="#A9CA9A" stroke="#000000" stroke-miterlimit="10" width="60.999" height="60.999"/>
                <rect x="436.629" y="0.5" fill="none" width="377.253" height="96.833"/>
                <text transform="matrix(1 0 0 1 523.2671 55.0605)"><tspan x="0" y="0" font-family="'AdobeMyungjoStd-Medium-KSCpc-EUC-H'" font-size="62">ERICA</tspan><tspan x="16.345" y="40.8" font-family="'AdobeMyungjoStd-Medium-KSCpc-EUC-H'" font-size="34">restaurant</tspan></text>
                <circle fill="#A9CA9A" stroke="#000000" stroke-miterlimit="10" cx="416.193" cy="550.116" r="20.384"/>
                <rect x="0.5" y="699.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="202.553" height="74.299"/>
                <polygon fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" points="215.807,773.833 395.807,773.833 395.807,652.385
                    324.307,652.385 324.307,699.534 215.807,699.534 "/>
                <rect x="215.807" y="785.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="180" height="69.299"/>
                <rect x="0.5" y="785.534" fill="#F8F6F1" stroke="#000000" stroke-miterlimit="10" width="202.553" height="69.299"/>
            </svg>`;
window.onload = () => {
    $("search").onclick = () => {
        new Ajax.Request("/api/restaruants/search",{
            method: "POST",
            parameters: {query: $("text").value},
            onSuccess: successSearch,
            onFailure: ajaxFailed,
            onException: ajaxFailed
        });
    }

    $("geolocation").onclick = getGeoLocation;

    draw_map();
}

function successSearch(ajax) {
    if (!document.querySelector("svg#layer_1")) { draw_map(); }
    const restaruants = JSON.parse(ajax.responseText);
    const rects = $$('rect.box');
    for(var i = 0; i < rects.length; i++) {
        var item = rects[i];
        document.getElementById(item.id).classList.remove("selected");
        if(restaruants.indexOf(item.id.substring(1)) != -1) {
            document.getElementById(item.id).classList.add('search');
        } else {
            document.getElementById(item.id).classList.remove('search');
        }
    }
    event_handling();
}

function getGeoLocation() {
    if (!document.querySelector("svg#layer_1")) { draw_map(); }
    if('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition((success) => {
            console.log(success);
            new Ajax.Request("/api/restaruants/nearby", {
                method: "GET", 
                parameters: {
                    lat: success.coords.latitude,
                    lng: success.coords.longitude
                },
                onSuccess: (ajax) => {
                    const restaruants = JSON.parse(ajax.responseText);
                    const rects = $$('rect.box');
                    for(var i = 0; i < rects.length; i++) {
                        var item = rects[i];
                        document.getElementById(item.id).classList.remove('search');
                        if(restaruants.indexOf(item.id.substring(1)) != -1) {
                            document.getElementById(item.id).classList.add('selected');
                        } else {
                            document.getElementById(item.id).classList.remove('selected');
                        }
                    }
                },
                onFailure: ajaxFailed,
                onException: ajaxFailed
            }
        );
        }, (failure) => {
            console.error(failure);
        })
    } else {
        alert('지오로케이션이 지원되지 않는 환경입니다.');
        return;
    }
}

function draw_map() {
    new Ajax.Request("/api/restaruants/",
    {
        method: "get",
        onSuccess: (ajax) => {
            stores = JSON.parse(ajax.responseText);
            removeElements(".map");
            for(var i = 0; i < stores.length; i++) {
                var item = stores[i];
                const rect = document.createElement('rect');
                rect.setAttribute('x', item.x);
                rect.setAttribute('y', item.y);
                rect.setAttribute('fill', "#878787");
                rect.setAttribute('stroke', "#000000");
                rect.setAttribute('stroke-miterlimit', "10");
                rect.setAttribute('width', "18");
                rect.setAttribute('height', "18");
                if(item.is_rotated) {
                    rect.setAttribute('transform', 'matrix(0.7071 -0.7071 0.7071 0.7071 '+ item.rx +' '+ item.ry +')')
                }
                rect.classList.add('box');
                rect.id = ('b' + item.ID);
                map.appendChild(rect);
            }
            var newmap = map.innerHTML.substring(0, map.innerHTML.length);
            map.innerHTML = ''
            map.innerHTML = newmap;
            $$("main")[0].appendChild(map);
            event_handling();
        },
        onFailure: ajaxFailed,
        onException: ajaxFailed
    });
}

function event_handling() {
    var boxes = $$(".box");
    for (var i = 0; i < boxes.length; i++) {
        boxes[i].onmousemove = (event) => {
            var x = event.pageX - ($("popup").getWidth()/2);
            var y = event.pageY - 60;
            popupRefresh(x,y);
        }
        boxes[i].onmouseover = (event) => {
            var id = event.target.getAttribute("id").substring(1);
            loadStore(stores[id-1]);
        };
        boxes[i].onmouseout = () => {
            $("popup").setStyle({
                display: "none"
            });
        }
        boxes[i].onclick = (event) => {
            $("popup").setStyle({
                display: "none"
            });
            var id = event.target.getAttribute("id").substring(1);
            window.location = "#" + id
            new Ajax.Request("/api/restaruants/" + id,{
                method: "GET",
                onSuccess: moveStore,
                onFailure: ajaxFailed,
                onException: ajaxFailed
            });
        }
    }
}

function loadStore(store) {
    while ($("popup").firstChild){
        $("popup").removeChild($("popup").firstChild);
    }

    var title = document.createElement("h1");
    title.innerText = store.name;

    var category = document.createElement("p");
    category.innerText = store.branch + " > " + store.sub_branch;
    
    $("popup").appendChild(title);
    $("popup").appendChild(category);

    $("popup").setStyle({
        display: "block"
    });
}

function popupRefresh(x, y) {
    $("popup").setStyle({
        top:y,
        left:x
    });
}

function moveStore(ajax) {
    var info = JSON.parse(ajax.responseText);
    var store = info.store;
    var menus = info.menus;
    removeElements("main");

    console.log(info);

    var body = document.createElement("div");
    body.setAttribute("class", "body");

    var header = document.createElement("div");
    header.setAttribute("class", "header");

    var pictrue = document.createElement("div");
    pictrue.setAttribute("class", "pictrue");

    var img = document.createElement("img");
    img.setAttribute("src", "http://placehold.it/360x360");
    img.setAttribute("class", "main");

    var txt = document.createElement("div");
    txt.setAttribute("class", "txt");
    var original = document.createElement("p");
    original.setAttribute("id", "original");
    original.innerText = store.branch + " > " + store.sub_branch;
    var r_name = document.createElement("p");
    r_name.setAttribute("id", "r_name");
    r_name.innerText = store.name;
    var add = document.createElement("p");
    add.setAttribute("id", "add");
    add.innerText = store.address_1;
    var phone = document.createElement("p");
    phone.setAttribute("id", "phone");
    phone.innerText = store.tel;

    var menu = document.createElement("p");
    menu.setAttribute("id", "menu");
    menu.innerText = "MENU";
    var hr = document.createElement("hr");
    hr.setAttribute("class", "menu-hr");

    txt.appendChild(original);
    txt.appendChild(r_name);
    txt.appendChild(add);
    txt.appendChild(phone);
    pictrue.appendChild(img);
    header.appendChild(pictrue);
    header.appendChild(txt);
    body.appendChild(header);

    body.appendChild(menu);
    body.appendChild(hr);


    for (var i = 0; i < menus.length; i++) {
        var menucard = document.createElement("div");
        menucard.setAttribute("class", "menucard");

        var menu_name = document.createElement("span");
        menu_name.setAttribute("class", "menu_name");
        menu_name.innerText = menus[i].name;

        var menu_price = document.createElement("span");
        menu_price.setAttribute("class", "menu_price");
        menu_price.innerText = menus[i].price + "원";

        menucard.appendChild(menu_name);
        menucard.appendChild(menu_price);

        var card_hr = document.createElement("hr");
        card_hr.setAttribute("class", "card-hr");

        body.appendChild(menucard);
        body.appendChild(card_hr);
    }

    $$("main")[0].appendChild(body);
    function_name(store.ID);

}

function function_name(id) {
    new Ajax.Request("/api/replys/" + id, {
        method: "GET",
        onSuccess: (ajax) => {
            var replys = JSON.parse(ajax.responseText);
            console.log(replys);
            var divs = document.createElement("div");
            divs.setAttribute("class", "replys");
            for (var i = 0; i < replys.length; i++) {
                var div = document.createElement("div");
                div.setAttribute("class", "reply");

                var username = document.createElement("span");
                username.innerText = replys[i].username;
                username.setAttribute("class", "username");
                var reply = document.createElement("span");
                reply.innerText = replys[i].reply;
                reply.setAttribute("class", "reply");
                var created = document.createElement("span");
                created.innerText = replys[i].created;
                created.setAttribute("class", "created");
                var hr = document.createElement("hr");

                div.appendChild(username);
                div.appendChild(created);
                div.appendChild(reply);

                divs.appendChild(div);
                divs.appendChild(hr);
            }

            var comments = document.createElement("p");
            comments.setAttribute("id", "comments");
            comments.innerText = "COMMENTS";

            $$(".body")[0].appendChild(comments);
            var hr = document.createElement("hr");
            hr.setAttribute("class", "menu-hr");
            $$(".body")[0].appendChild(hr);

            $$(".body")[0].appendChild(divs);

            var form = document.createElement("form");
            var username = document.createElement("input");
            username.setAttribute("type", "text");
            username.setAttribute("name", "username");
            username.setAttribute("id", "username");
            var password = document.createElement("input");
            password.setAttribute("type", "password");
            password.setAttribute("name", "password");
            password.setAttribute("id", "password");
            var contents = document.createElement("textarea");
            contents.setAttribute("name", "contents");
            contents.setAttribute("id", "contents");
            var submit = document.createElement("input");
            submit.setAttribute("type", "submit");

            form.appendChild(username);
            form.appendChild(password);
            form.appendChild(contents);
            form.appendChild(submit);
            $$(".body")[0].appendChild(form);
        },
        onFailure: ajaxFailed,
        onException: ajaxFailed
    });
}

function removeElements(query) {
    while ($$(query)[0].firstChild){
        $$(query)[0].removeChild($$(query)[0].firstChild);
    }
}

function ajaxFailed(ajax, exception) {
    var errorMessage = "Error making Ajax request:\n\n";
    if (exception) {
        errorMessage += "Exception: " + exception.message;
    } else {
        errorMessage += "Server status:\n" + ajax.status + " " + ajax.statusText + 
                        "\n\nServer response text:\n" + ajax.responseText;
    }
    console.log(errorMessage);
}

